/*! homework_10 2020-01-17 */

"use strict";var _get=function t(e,o,r){null===e&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,o);if(void 0===n){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,o,r)}if("value"in n)return n.value;var d=n.get;return void 0!==d?d.call(r):void 0},_createClass=function(){function r(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,o){return e&&r(t.prototype,e),o&&r(t,o),t}}();function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var User=function(){function n(t,e,o,r){_classCallCheck(this,n),this.surname=t,this.name=e,this.login=o,this.password=r,this.getSurname=function(){return surname},this.getName=function(){return name},this.getLogin=function(){return login},this.getPassword=function(){return password}}return _createClass(n,[{key:"toString",value:function(){return"<td>"+this._surname+"</td><td>"+this._name+"</td><td>"+this._login+"</td><td>"+this._password+"</td>"}}]),n}(),Worker=function(){function d(t,e,o,r,n){_classCallCheck(this,d);var i=_possibleConstructorReturn(this,(d.__proto__||Object.getPrototypeOf(d)).call(this,t,e,o,r));return i.job=n,i.getJob=function(){return job},i}return _inherits(d,User),_createClass(d,[{key:"toString",value:function(){return _get(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"toString",this).call(this)+"<td>"+this._job+"</td>"}}]),d}(),express=require("express"),app=express(),bodyParser=require("body-parser");app.use(bodyParser.urlencoded({extended:!1}));var mongojs=require("mongojs"),db=mongojs("lab11",["user"]);function getUsers(d){return new Promise(function(n,i){db.collection("user").find().toArray(function(t,e){if(t)return i(t);for(var o=!1,r=0;r<e.length;r++)e[r]._id==d&&(o=!0);return n(o)})})}function getWorkers(d){return new Promise(function(n,i){db.collection("worker").find().toArray(function(t,e){if(t)return i(t);for(var o=!1,r=0;r<e.length;r++)e[r]._id==d&&(o=!0);return n(o)})})}app.get("/",function(t,e){e.sendFile(process.cwd()+"/index.html")}),app.get("/show-user-data",function(t,n){db.collection("user").find({}).toArray(function(t,e){if(t)throw t;var o='<table style="width: 100%" border="1">';o+="<tr><th>Id</th><th>Surname</th><th>Name</th><th>Login</th><th>Password</th></tr>";for(var r=0;r<e.length;r++)o+="<tr><td>"+e[r]._id+"</td><td>"+e[r].surname+"</td><td>"+e[r].name+"</td><td>"+e[r].login+"</td><td>"+e[r].password+"</td></tr>";n.send(o+'</table><form action="/" method="get"><input type="submit" value="Back"/></form>'),n.end()})}),app.get("/show-worker-data",function(t,n){db.collection("worker").find({}).toArray(function(t,e){if(t)throw t;var o='<table style="width: 100%" border="1">';o+="<tr><th>Id</th><th>Surname</th><th>Name</th><th>Login</th><th>Password</th><th>Job</th></tr>";for(var r=0;r<e.length;r++)o+="<tr><td>"+e[r]._id+"</td><td>"+e[r].surname+"</td><td>"+e[r].name+"</td><td>"+e[r].login+"</td><td>"+e[r].password+"</td><td>"+e[r].job+"</td></tr>";n.send(o+'</table><form action="/" method="get"><input type="submit" value="Back"/></form>'),n.end()})}),app.post("/submit-user-data",function(t,e){if(""===t.body.Job){var o=new User(t.body.Surname,t.body.Name,t.body.Login,t.body.Password);db.collection("user").insertOne(o,function(t,e){if(t)throw t;console.log("Document inserted")}),e.redirect("/")}else{var r=new Worker(t.body.Surname,t.body.Name,t.body.Login,t.body.Password,t.body.Job);db.collection("worker").insertOne(r,function(t,e){if(t)throw t;console.log("Document inserted")}),e.redirect("/")}e.end()}),app.post("/update-user-data",function(r,t){""===r.body.uJob?getUsers(r.body.Id).then(function(t){if(1==t){var e={$set:new User(r.body.uSurname,r.body.uName,r.body.uLogin,r.body.uPassword)},o={_id:new(require("mongodb").ObjectID)(r.body.Id)};db.collection("user").updateOne(o,e,function(t,e){if(t)throw t;console.log("1 document updated")})}else console.log("Wrong id")}):getWorkers(r.body.Id).then(function(t){if(1==t){var e={$set:new Worker(r.body.uSurname,r.body.uName,r.body.uLogin,r.body.uPassword,r.body.uJob)},o={_id:new(require("mongodb").ObjectID)(r.body.Id)};db.collection("worker").updateOne(o,e,function(t,e){if(t)throw t;console.log("1 document updated")})}else console.log("Wrong id")}),t.redirect("/"),t.end()}),app.post("/delete-user-data",function(n,i){var d=!1;db.collection("user").find({}).toArray(function(t,e){for(var o=0;o<e.length;o++)e[o]._id==n.body.dId&&(d=!0);db.collection("worker").find({}).toArray(function(t,e){for(var o=0;o<e.length;o++)e[o]._id==n.body.dId&&(d=!0);if(0==d)i.send('wrong id<form action="/" method="get"><input type="submit" value="Back"/></form>');else{var r={_id:new(require("mongodb").ObjectID)(n.body.dId)};db.collection("user").remove(r,function(t,e){if(t)throw t}),db.collection("worker").remove(r,function(t,e){if(t)throw t}),i.redirect("/"),i.end()}})})});var server=app.listen(5e3,function(){console.log("Node server is running..")});